{% extends "base.html" %}

{% block title %}Crear Rutina - FocusFit{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/crear_rutina.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header moderno -->
    <div class="text-center mb-5">
        <h2 class="section-header fs-3 fw-bold mb-2">Crear nueva rutina</h2>
        <p class="text-muted fs-6">Dise침a tu rutina personalizada para alcanzar tus objetivos</p>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white" style="padding: 1.5rem;">
                    <div class="d-flex align-items-center">
                        <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                            <i class="fas fa-plus text-white"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-semibold">Nueva rutina</h5>
                            <small class="text-white-50">Completa los campos para crear tu rutina</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
<form method="post" id="formRutina" enctype="multipart/form-data">
    <!-- 游댃 Campo hidden para mantener informaci칩n de navegaci칩n -->
    <input type="hidden" name="from" value="{{ from_page }}">

    <!-- Informaci칩n b치sica -->
    <div class="row mb-4">
        <div class="col-12">
            <h6 class="text-primary fw-semibold mb-3">
                <i class="fas fa-info-circle me-2"></i>Informaci칩n b치sica
            </h6>
        </div>
    </div>

    <!-- Nombre -->
    <div class="mb-4">
        <label for="nombre" class="form-label fw-semibold">Nombre de la rutina</label>
        <input type="text" class="form-control form-control-lg" id="nombre" name="nombre" 
               placeholder="Ej: Entrenamiento matutino, Estudio de matem치ticas...">
        <div class="text-danger small error-msg mt-1" id="nombreError">Este campo es obligatorio</div>
    </div>

    <!-- Tipo de rutina -->
    <div class="mb-4">
        <label for="tipo" class="form-label fw-semibold">Tipo de rutina</label>
        <select class="form-select form-select-lg" id="tipo" name="tipo">
            <option value="">-- Selecciona el tipo --</option>
            <option value="estudio">游닄 Estudio</option>
            <option value="ejercicio">游눩 Ejercicio</option>
        </select>
        <div class="text-danger small error-msg mt-1" id="tipoError">Selecciona primero un tipo de rutina</div>
    </div>

    <!-- Configuraci칩n de tiempo -->
    <div class="row mb-4">
        <div class="col-12">
            <h6 class="text-primary fw-semibold mb-3">
                <i class="fas fa-clock me-2"></i>Configuraci칩n de tiempo
            </h6>
        </div>
    </div>

    <!-- Duraci칩n -->
    <div class="mb-4">
        <label class="form-label fw-semibold">Duraci칩n total</label>
        <div class="row g-3">
            <div class="col-6">
                <div class="input-group">
                    <input type="number" min="0" class="form-control form-control-lg" 
                           id="duracionHoras" name="duracion_horas" placeholder="0">
                    <span class="input-group-text">horas</span>
                </div>
            </div>
            <div class="col-6">
                <div class="input-group">
                    <input type="number" min="0" max="59" class="form-control form-control-lg" 
                           id="duracionMinutos" name="duracion_minutos" placeholder="0">
                    <span class="input-group-text">minutos</span>
                </div>
            </div>
        </div>
        <div class="text-danger small error-msg mt-1" id="duracionError">Debes especificar la duraci칩n</div>
    </div>

    <!-- Horario -->
    <div class="mb-4">
        <label for="horario" class="form-label fw-semibold">Horario preferido</label>
        <input type="time" class="form-control form-control-lg" id="horario" name="horario">
        <div class="form-text">Selecciona la hora en que prefieres realizar esta rutina</div>
        <div class="text-danger small error-msg mt-1" id="horarioError">Selecciona un horario</div>
    </div>

    <!-- Programaci칩n de d칤as -->
    <div class="row mb-4">
        <div class="col-12">
            <h6 class="text-primary fw-semibold mb-3">
                <i class="fas fa-calendar-alt me-2"></i>Programaci칩n
            </h6>
        </div>
    </div>

    <!-- D칤as tipo calendario -->
    <div class="mb-4">
        <label class="form-label fw-semibold">D칤as de la semana</label>
        <div class="dias-calendario mt-3">
            {% for dia in ['Lunes','Martes','Mi칠rcoles','Jueves','Viernes','S치bado','Domingo'] %}
            <div class="dia" data-dia="{{ dia }}">
                <span>{{ dia[:3] }}</span>
                <small class="d-block">{{ dia[3:] }}</small>
            </div>
            {% endfor %}
        </div>
        <input type="hidden" name="diasSeleccionados" id="diasSeleccionados">
        <div class="form-text">Selecciona los d칤as en que realizar치s esta rutina</div>
        <div class="text-danger small error-msg mt-1" id="diasError">Selecciona al menos un d칤a</div>
    </div>

    <!-- Contenido de la rutina -->
    <div class="row mb-4">
        <div class="col-12">
            <h6 class="text-primary fw-semibold mb-3">
                <i class="fas fa-list me-2"></i>Contenido de la rutina
            </h6>
        </div>
    </div>

    <!-- Items din치micos -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <label class="form-label fw-semibold mb-0">Actividades</label>
            <button type="button" class="btn btn-outline-primary" id="agregarItemBtn">
                <i class="fas fa-plus me-2"></i>Agregar actividad
            </button>
        </div>
        <div id="itemsContainer" class="mb-3"></div>
        <div class="text-danger small error-msg" id="itemsError">Agrega al menos una actividad</div>
    </div>

    <!-- Botones de acci칩n -->
    <div class="d-flex justify-content-between align-items-center pt-4 border-top">
        {% if from_page == 'planificador' %}
            <a href="{{ url_for('planificador') }}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Cancelar
            </a>
        {% else %}
            <a href="{{ url_for('inicio') }}" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Cancelar
            </a>
        {% endif %}
        <button type="submit" class="btn btn-primary btn-lg px-4">
            <i class="fas fa-save me-2"></i>Guardar rutina
        </button>
    </div>
</form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Publish to community options -->
<script>
// A침adir checkbox din치mico para publicar en comunidad
const formRutina = document.getElementById('formRutina');
// Insert a small block before submit with publish option
const publishBlock = document.createElement('div');
publishBlock.className = 'card border-0 bg-light mt-4 mb-4';
publishBlock.innerHTML = `
    <div class="card-body">
        <h6 class="text-primary fw-semibold mb-3">
            <i class="fas fa-share-alt me-2"></i>Compartir en comunidad
        </h6>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" value="1" id="publishCommunity" name="publish_community">
            <label class="form-check-label fw-semibold" for="publishCommunity">
                Publicar esta rutina en la comunidad
            </label>
            <div class="form-text">Permite que otros usuarios puedan descubrir y usar tu rutina</div>
        </div>
        <div id="communityDetails" style="display:none;">
            <div class="mb-3">
                <label class="form-label fw-semibold">Resumen motivacional</label>
                <textarea name="community_summary" class="form-control" rows="3" 
                          placeholder="Explica por qu칠 recomiendas esta rutina, qu칠 beneficios tiene, para qui칠n es ideal..."></textarea>
                <div class="form-text">Describe los beneficios y para qui칠n es recomendable esta rutina</div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold">Imagen motivacional <span class="text-muted">(opcional)</span></label>
                <input type="file" name="community_image" id="communityImageInput" accept="image/*" class="form-control">
                <div class="form-text">Agrega una imagen que inspire o represente tu rutina</div>
                <img id="communityImagePreview" src="" style="display:none; max-height:120px; margin-top:12px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
            </div>
            <div class="mb-3">
                <label class="form-label fw-semibold">Hacer p칰blica como recomendaci칩n</label>
                <select name="community_visibility" class="form-select">
                    <option value="0">Solo visible en la comunidad</option>
                    <option value="1">Tambi칠n mostrar como recomendaci칩n p칰blica</option>
                </select>
                <div class="form-text">Las recomendaciones p칰blicas aparecen destacadas para todos los usuarios</div>
            </div>
        </div>
    </div>
`;

// Agregar secci칩n de comunidad antes de los botones
const buttonsContainer = formRutina.querySelector('.d-flex.justify-content-between.align-items-center.pt-4');
buttonsContainer.before(publishBlock);

document.getElementById('publishCommunity').addEventListener('change', function(e){
    document.getElementById('communityDetails').style.display = this.checked ? 'block' : 'none';
});

// Preview image when chosen
document.getElementById('communityImageInput')?.addEventListener('change', function(e){
        const file = this.files && this.files[0];
        const preview = document.getElementById('communityImagePreview');
        if(!file){ preview.style.display = 'none'; preview.src = ''; return; }
        const url = URL.createObjectURL(file);
        preview.src = url; preview.style.display = 'block';
});
</script>
</script>


<script>
const form = document.getElementById('formRutina');
const tipoSelect = document.getElementById('tipo');
const tipoError = document.getElementById('tipoError');
const nombre = document.getElementById('nombre');
const nombreError = document.getElementById('nombreError');
const duracionHoras = document.getElementById('duracionHoras');
const duracionMinutos = document.getElementById('duracionMinutos');
const duracionError = document.getElementById('duracionError');
const horario = document.getElementById('horario');
const horarioError = document.getElementById('horarioError');
const dias = document.querySelectorAll('.dia');
const diasSeleccionadosInput = document.getElementById('diasSeleccionados');
const diasError = document.getElementById('diasError');
const itemsContainer = document.getElementById('itemsContainer');
const itemsError = document.getElementById('itemsError');

// Ocultar errores inicialmente
[nombreError, tipoError, duracionError, horarioError, diasError, itemsError].forEach(e => e.style.display = 'none');

// Calendario de d칤as
dias.forEach(dia => {
    dia.addEventListener('click', () => {
        dia.classList.toggle('seleccionado');
        actualizarDiasSeleccionados();
    });
});

function actualizarDiasSeleccionados() {
    const seleccionados = Array.from(dias)
        .filter(d => d.classList.contains('seleccionado'))
        .map(d => d.dataset.dia);
    diasSeleccionadosInput.value = seleccionados.join(',');
}

// Calcular duraci칩n total en minutos
function duracionTotalMinutos() {
    const h = parseInt(duracionHoras.value) || 0;
    const m = parseInt(duracionMinutos.value) || 0;
    return h*60 + m;
}

// Distribuir autom치ticamente el tiempo entre items de estudio
function distribuirTiempoItems() {
    const tipo = tipoSelect.value;
    if(tipo !== 'estudio') return;

    const totalMin = duracionTotalMinutos();
    const items = Array.from(itemsContainer.children);

    if(items.length === 0) return;

    // Si hay un solo item, ocupa todo el tiempo
    if(items.length === 1) {
        const tiempoInput = items[0].querySelector('.item-tiempo');
        if(tiempoInput){
            tiempoInput.value = totalMin;
            tiempoInput.parentElement.style.display = 'none';
        }
        return;
    }

    // Si hay m치s de un item
    let manualSum = 0;
    let autoItems = [];
    items.forEach(item => {
        let input = item.querySelector('.item-tiempo');
        if(!input){
            // crear input si no existe
            const col = item.querySelector('.col-tiempo');
            col.style.display = 'block';
            col.innerHTML = `<label>Tiempo (min)</label>
                             <input type="number" class="form-control item-tiempo" name="item_tiempo[]" value="0" min="0" required>`;
            input = col.querySelector('input');
        }
        if(input.dataset.manual === 'true') {
            manualSum += parseInt(input.value) || 0;
        } else {
            autoItems.push(input);
        }
    });

    // Distribuir tiempo restante
    let restante = totalMin - manualSum;
    if(restante < 0){
        // Ajustar proporcionalmente los manuales si exceden
        alert('Los tiempos asignados exceden la duraci칩n total de la rutina. Se ajustar치n autom치ticamente.');
        items.forEach(item => {
            const input = item.querySelector('.item-tiempo');
            input.value = Math.floor(totalMin / items.length);
            input.dataset.manual = 'false';
        });
        return;
    }

    const porItem = Math.floor(restante / autoItems.length);
    autoItems.forEach(input => input.value = porItem);
}

// Crear item din치mico mejorado
function crearItem(tipo){
    const container = document.createElement('div');
    container.classList.add('card','border-0','shadow-sm','mb-3');

    const tipoIcon = tipo === 'ejercicio' ? 'fas fa-dumbbell' : 'fas fa-book';
    const tipoColor = tipo === 'ejercicio' ? 'success' : 'primary';
    const tipoTexto = tipo === 'ejercicio' ? 'Ejercicio' : 'Materia de estudio';

    let html = `
        <div class="card-header bg-${tipoColor} text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="${tipoIcon} me-2"></i>
                <span class="fw-semibold">${tipoTexto}</span>
            </div>
            <button type="button" class="btn btn-outline-light btn-sm eliminarItemBtn">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-semibold">Nombre</label>
                <input type="text" class="form-control" name="item_nombre[]" 
                       placeholder="Nombre del ${tipo === 'ejercicio' ? 'ejercicio' : 'tema de estudio'}" required>
            </div>`;

    if(tipo === 'ejercicio'){
        html += `
            <div class="row g-3">
                <div class="col-6">
                    <label class="form-label fw-semibold">Series</label>
                    <input type="number" class="form-control" name="item_series[]" 
                           placeholder="0" min="1" required>
                </div>
                <div class="col-6">
                    <label class="form-label fw-semibold">Repeticiones</label>
                    <input type="number" class="form-control" name="item_repeticiones[]" 
                           placeholder="0" min="1" required>
                </div>
            </div>`;
    } else {
        html += `
            <div class="row g-3">
                <div class="col col-tiempo" style="display:none;"></div>
                <div class="col-12">
                    <label class="form-label fw-semibold">Prioridad</label>
                    <select class="form-select" name="item_prioridad[]" required>
                        <option value="">-- Selecciona la prioridad --</option>
                        <option value="alta">游댮 Alta</option>
                        <option value="media">游리 Media</option>
                        <option value="baja">游릭 Baja</option>
                    </select>
                </div>
            </div>`;
    }

    html += `
        </div>`;
    container.innerHTML = html;

    container.querySelector('.eliminarItemBtn').addEventListener('click', () => {
        container.remove();
        distribuirTiempoItems();
    });

    return container;
}

// Marcar inputs de tiempo como manual si el usuario cambia el valor
itemsContainer.addEventListener('input', e => {
    if(e.target.classList.contains('item-tiempo')){
        e.target.dataset.manual = 'true';
        distribuirTiempoItems();
    }
});

// Cambiar tipo de rutina limpia items existentes
tipoSelect.addEventListener('change', () => {
    itemsContainer.innerHTML = '';
});

// Bot칩n agregar item
document.getElementById('agregarItemBtn').addEventListener('click', () => {
    const tipo = tipoSelect.value;
    if(!tipo){
        tipoError.style.display = 'block';
        return;
    }
    tipoError.style.display = 'none';
    const item = crearItem(tipo);
    itemsContainer.appendChild(item);
    distribuirTiempoItems();
});

// Actualizar tiempo cuando cambian horas o minutos de la rutina
[duracionHoras, duracionMinutos].forEach(input => {
    input.addEventListener('input', distribuirTiempoItems);
});

// Validaci칩n de formulario
form.addEventListener('submit', function(e){
    let valido = true;

    // Nombre
    if(nombre.value.trim() === ''){
        nombreError.style.display = 'block';
        valido = false;
    } else nombreError.style.display = 'none';

    // Tipo
    if(tipoSelect.value === ''){
        tipoError.style.display = 'block';
        valido = false;
    } else tipoError.style.display = 'none';

    // Duraci칩n
    if(duracionTotalMinutos() === 0){
        duracionError.style.display = 'block';
        valido = false;
    } else duracionError.style.display = 'none';

    // Horario
    if(horario.value === ''){
        horarioError.style.display = 'block';
        valido = false;
    } else horarioError.style.display = 'none';

    // D칤as
    actualizarDiasSeleccionados();
    if(diasSeleccionadosInput.value === ''){
        diasError.style.display = 'block';
        valido = false;
    } else diasError.style.display = 'none';

    // Items
    if(itemsContainer.children.length === 0){
        itemsError.style.display = 'block';
        valido = false
    } else {
        const inputs = itemsContainer.querySelectorAll('input, select');
        inputs.forEach(input => {
            if(input.required && input.value.trim() === ''){
                input.classList.add('is-invalid');
                valido = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });
        itemsError.style.display = 'none';
    }

    if(!valido) e.preventDefault();
});
</script>



{% endblock %}
