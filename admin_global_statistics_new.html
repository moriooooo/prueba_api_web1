{% extends "admin/admin_layout.html" %}

{% block title %}Estad칤sticas Globales - FocusFit Admin{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<style>
.stats-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 15px;
  color: white;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stats-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
}

.stats-icon {
  font-size: 2rem;
  opacity: 0.9;
}

.filter-card {
  background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
  border: none;
  border-radius: 15px;
  color: white;
  margin-bottom: 2rem;
}

.export-btn {
  border-radius: 10px;
  padding: 8px 20px;
  font-weight: 500;
  transition: all 0.3s ease;
}

.export-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.table-responsive {
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.period-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
}

.type-btn.active {
  background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
  color: white;
  border: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">游늵 Estad칤sticas Globales</h1>
          <p class="text-muted">An치lisis detallado del uso de la aplicaci칩n</p>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('admin.global_statistics', export='csv', tipo=filtro_tipo, periodo=periodo) }}" 
             class="btn btn-outline-success export-btn">
            <i class="fas fa-file-csv me-1"></i>Exportar CSV
          </a>
          <a href="{{ url_for('admin.global_statistics', export='pdf', tipo=filtro_tipo, periodo=periodo) }}" 
             class="btn btn-outline-danger export-btn">
            <i class="fas fa-file-pdf me-1"></i>Exportar PDF
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card filter-card">
        <div class="card-body">
          <h5 class="card-title mb-3">游댌 Filtros de An치lisis</h5>
          
          <!-- Filtros de Per칤odo -->
          <div class="mb-3">
            <label class="form-label fw-bold">Per칤odo de An치lisis:</label>
            <div class="btn-group" role="group">
              <a href="{{ url_for('admin.global_statistics', tipo=filtro_tipo, periodo='semana') }}" 
                 class="btn btn-outline-primary period-btn {{ 'active' if periodo == 'semana' else '' }}">
                游늰 칔ltima Semana
              </a>
              <a href="{{ url_for('admin.global_statistics', tipo=filtro_tipo, periodo='mes') }}" 
                 class="btn btn-outline-primary period-btn {{ 'active' if periodo == 'mes' else '' }}">
                游늰 칔ltimo Mes
              </a>
              <a href="{{ url_for('admin.global_statistics', tipo=filtro_tipo, periodo='a침o') }}" 
                 class="btn btn-outline-primary period-btn {{ 'active' if periodo == 'a침o' else '' }}">
                游늰 칔ltimo A침o
              </a>
            </div>
          </div>
          
          <!-- Filtros de Tipo -->
          <div class="mb-0">
            <label class="form-label fw-bold">Tipo de Actividad:</label>
            <div class="btn-group" role="group">
              <a href="{{ url_for('admin.global_statistics', tipo=None, periodo=periodo) }}" 
                 class="btn btn-outline-success type-btn {{ 'active' if not filtro_tipo else '' }}">
                游댃 Todas las Actividades
              </a>
              <a href="{{ url_for('admin.global_statistics', tipo='ejercicio', periodo=periodo) }}" 
                 class="btn btn-outline-success type-btn {{ 'active' if filtro_tipo == 'ejercicio' else '' }}">
                游눩 Solo Ejercicio
              </a>
              <a href="{{ url_for('admin.global_statistics', tipo='estudio', periodo=periodo) }}" 
                 class="btn btn-outline-success type-btn {{ 'active' if filtro_tipo == 'estudio' else '' }}">
                游닄 Solo Estudio
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Estad칤sticas Principales -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body text-center">
          <div class="stats-icon mb-2">
            <i class="fas fa-users"></i>
          </div>
          <h3 class="mb-1">{{ stats.usuarios_totales or 0 }}</h3>
          <p class="mb-0 opacity-75">Usuarios Totales</p>
          <small class="opacity-50">{{ stats.usuarios_activos or 0 }} activos en el per칤odo</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body text-center">
          <div class="stats-icon mb-2">
            <i class="fas fa-list-check"></i>
          </div>
          <h3 class="mb-1">{{ stats.rutinas_creadas or 0 }}</h3>
          <p class="mb-0 opacity-75">Rutinas Creadas</p>
          <small class="opacity-50">{{ stats.rutinas_ejercicio or 0 }} ejercicio, {{ stats.rutinas_estudio or 0 }} estudio</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body text-center">
          <div class="stats-icon mb-2">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3 class="mb-1">{{ stats.actividades_completadas or 0 }}</h3>
          <p class="mb-0 opacity-75">Actividades Completadas</p>
          <small class="opacity-50">{{ stats.actividades_ejercicio or 0 }} ejercicio, {{ stats.actividades_estudio or 0 }} estudio</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card h-100">
        <div class="card-body text-center">
          <div class="stats-icon mb-2">
            <i class="fas fa-chart-line"></i>
          </div>
          {% set tasa_completado = (stats.actividades_completadas / stats.rutinas_creadas * 100) if stats.rutinas_creadas and stats.rutinas_creadas > 0 else 0 %}
          <h3 class="mb-1">{{ "%.1f"|format(tasa_completado) }}%</h3>
          <p class="mb-0 opacity-75">Tasa de Completado</p>
          <small class="opacity-50">Actividades vs Rutinas</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr치ficos -->
  <div class="row mb-4">
    <!-- Gr치fico de Uso por Per칤odo -->
    <div class="col-lg-8 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">游늳 Actividades Completadas por Mes</h5>
        </div>
        <div class="card-body">
          <canvas id="usoChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Gr치fico de Distribuci칩n por Tipo -->
    <div class="col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">游꿢 Distribuci칩n por Tipo</h5>
        </div>
        <div class="card-body">
          <canvas id="tipoChart" width="400" height="400"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr치fico de Crecimiento -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">游논 Crecimiento de Usuarios por Mes</h5>
        </div>
        <div class="card-body">
          <canvas id="crecimientoChart" width="400" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tablas de Rankings -->
  <div class="row">
    <!-- Rutinas M치s Populares -->
    <div class="col-lg-6 mb-4">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th colspan="3" class="text-center">
                <i class="fas fa-trophy me-2"></i>Rutinas M치s Populares
              </th>
            </tr>
            <tr>
              <th>Rutina</th>
              <th>Tipo</th>
              <th>Usos</th>
            </tr>
          </thead>
          <tbody>
            {% for rutina in stats.rutinas_mas_populares[:10] %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-{{ 'dumbbell' if rutina.tipo == 'ejercicio' else 'book' }} me-2 text-primary"></i>
                  {{ rutina.nombre[:30] }}{% if rutina.nombre|length > 30 %}...{% endif %}
                </div>
              </td>
              <td>
                <span class="badge bg-{{ 'success' if rutina.tipo == 'ejercicio' else 'info' }}">
                  {{ rutina.tipo.title() }}
                </span>
              </td>
              <td class="fw-bold">{{ rutina.usos or 0 }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="3" class="text-center text-muted">No hay datos disponibles</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Usuarios M치s Activos -->
    <div class="col-lg-6 mb-4">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th colspan="2" class="text-center">
                <i class="fas fa-star me-2"></i>Usuarios M치s Activos
              </th>
            </tr>
            <tr>
              <th>Usuario</th>
              <th>Actividades</th>
            </tr>
          </thead>
          <tbody>
            {% for usuario in stats.usuarios_mas_activos[:10] %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-user-circle me-2 text-primary"></i>
                  {{ usuario.nombre }} {{ usuario.apellido }}
                </div>
              </td>
              <td class="fw-bold">{{ usuario.actividades_completadas or 0 }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="2" class="text-center text-muted">No hay usuarios activos</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Debug: Verificar que Chart.js est치 cargado
console.log('Chart.js loaded:', typeof Chart !== 'undefined');

// Esperar a que el DOM est칠 listo
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing charts...');
  
  // Datos para los gr치ficos con validaci칩n
  const usoDataRaw = {{ stats.uso_por_periodo | tojson }};
  const tipoDataRaw = {{ stats.actividades_por_tipo | tojson }};
  const crecimientoDataRaw = {{ stats.crecimiento_usuarios | tojson }};

  console.log('Raw data:', {
    uso: usoDataRaw,
    tipo: tipoDataRaw,
    crecimiento: crecimientoDataRaw
  });

  // Validar y procesar datos
  const usoData = Array.isArray(usoDataRaw) && usoDataRaw.length > 0 ? usoDataRaw : [];
  const tipoData = Array.isArray(tipoDataRaw) && tipoDataRaw.length > 0 ? tipoDataRaw : [];
  const crecimientoData = Array.isArray(crecimientoDataRaw) && crecimientoDataRaw.length > 0 ? crecimientoDataRaw : [];

  // Funci칩n auxiliar para crear gr치fico vac칤o
  function createEmptyChart(ctx, type, message = 'No hay datos disponibles') {
    return new Chart(ctx, {
      type: type,
      data: {
        labels: [message],
        datasets: [{
          data: [1],
          backgroundColor: ['rgba(108, 117, 125, 0.3)'],
          borderColor: ['rgba(108, 117, 125, 0.5)'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });
  }

  // Gr치fico de uso por per칤odo
  try {
    const usoCtx = document.getElementById('usoChart');
    if (usoCtx) {
      if (usoData.length > 0) {
        new Chart(usoCtx, {
          type: 'line',
          data: {
            labels: usoData.map(d => d.fecha || 'Sin fecha'),
            datasets: [{
              label: 'Actividades Completadas',
              data: usoData.map(d => d.actividades || 0),
              borderColor: 'rgb(102, 126, 234)',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              x: {
                grid: { color: 'rgba(0,0,0,0.1)' }
              }
            }
          }
        });
        console.log('Uso chart created successfully');
      } else {
        createEmptyChart(usoCtx, 'line', 'Sin actividades registradas');
      }
    }
  } catch (error) {
    console.error('Error creating uso chart:', error);
  }

  // Gr치fico de tipo de actividades
  try {
    const tipoCtx = document.getElementById('tipoChart');
    if (tipoCtx) {
      if (tipoData.length > 0) {
        new Chart(tipoCtx, {
          type: 'doughnut',
          data: {
            labels: tipoData.map(d => d.tipo_actividad ? d.tipo_actividad.charAt(0).toUpperCase() + d.tipo_actividad.slice(1) : 'Sin tipo'),
            datasets: [{
              data: tipoData.map(d => d.total || 0),
              backgroundColor: [
                'rgba(102, 126, 234, 0.8)',
                'rgba(67, 160, 71, 0.8)',
                'rgba(255, 152, 0, 0.8)',
                'rgba(156, 39, 176, 0.8)'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
        console.log('Tipo chart created successfully');
      } else {
        createEmptyChart(tipoCtx, 'doughnut', 'Sin tipos de actividad');
      }
    }
  } catch (error) {
    console.error('Error creating tipo chart:', error);
  }

  // Gr치fico de crecimiento de usuarios
  try {
    const crecimientoCtx = document.getElementById('crecimientoChart');
    if (crecimientoCtx) {
      if (crecimientoData.length > 0) {
        new Chart(crecimientoCtx, {
          type: 'bar',
          data: {
            labels: crecimientoData.map(d => d.fecha || 'Sin fecha'),
            datasets: [{
              label: 'Nuevos Usuarios',
              data: crecimientoData.map(d => d.nuevos_usuarios || 0),
              backgroundColor: 'rgba(67, 160, 71, 0.8)',
              borderColor: 'rgb(67, 160, 71)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.1)' }
              },
              x: {
                grid: { color: 'rgba(0,0,0,0.1)' }
              }
            }
          }
        });
        console.log('Crecimiento chart created successfully');
      } else {
        createEmptyChart(crecimientoCtx, 'bar', 'Sin datos de usuarios');
      }
    }
  } catch (error) {
    console.error('Error creating crecimiento chart:', error);
  }
});
</script>
{% endblock %}